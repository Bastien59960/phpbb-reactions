#
# Fichier : config/services.yml — bastien59960/reactions/config/services.yml
#
# Fichier de déclaration des services pour l'extension Reactions.
#
# Ce fichier définit tous les services (contrôleurs, listeners, types de notifications, etc.) utilisés par l'extension et leur injection de dépendances.
#
# Points clés :
#   - Déclaration des services Symfony pour phpBB
#   - Mapping des classes et injection des dépendances
#
# Ce fichier est essentiel pour l'autowiring et l'intégration de l'extension dans le framework phpBB.
#

# Importer les paramètres depuis parameters.yml
# (noms des tables de base de données)
imports:
    - { resource: 'parameters.yml' }

services:
    # =========================================================================
    # LISTENER D'ÉVÉNEMENTS
    # =========================================================================
    # Écoute les événements phpBB et injecte le code de l'extension
    
    bastien59960.reactions.listener:
        class: bastien59960\reactions\event\listener
        arguments:
            - '@dbal.conn'                # 1. Connexion à la base de données
            - '@user'                     # 2. Utilisateur courant
            - '%tables.post_reactions%'   # 3. Table des réactions
            - '%tables.posts%'            # 4. Table des messages
            - '@template'                 # 5. Moteur de templates
            - '@language'                 # 6. Gestionnaire de langues
            - '@controller.helper'        # 7. Helper pour générer les URLs
            - '@config'                   # 8. Configuration du forum
        tags:
            - { name: event.listener }    # Enregistre comme listener d'événements

    # =========================================================================
    # CONTRÔLEUR PRINCIPAL
    # =========================================================================
    # Gère l'affichage et les opérations principales
    
    bastien59960.reactions.main:
        class: bastien59960\reactions\controller\main
        arguments:
            - '@dbal.conn'                # 1. Base de données
            - '@user'                     # 2. Utilisateur courant
            - '@request'                  # 3. Requêtes HTTP
            - '@template'                 # 4. Templates
            - '@auth'                     # 5. Autorisations
            - '@controller.helper'        # 6. Helper de contrôleur
            - '%tables.post_reactions%'   # 7. Table des réactions
            - '%tables.posts%'            # 8. Table des messages

    # =========================================================================
    # CONTRÔLEUR AJAX
    # =========================================================================
    # Gère les requêtes AJAX (ajout/suppression de réactions en temps réel)
    
    bastien59960.reactions.ajax:
        class: bastien59960\reactions\controller\ajax
        arguments:
            - '@dbal.conn'                # 1. Base de données
            - '@user'                     # 2. Utilisateur courant
            - '@request'                  # 3. Requêtes HTTP
            - '@auth'                     # 4. Autorisations
            - '@language'                 # 5. Langues
            - '%tables.post_reactions%'   # 6. Table des réactions
            - '%tables.posts%'            # 7. Table des messages
            - '%tables.topics%'           # 8. Table des sujets
            - '%tables.forums%'           # 9. Table des forums
            - '%core.root_path%'          # 10. Chemin racine phpBB
            - '%core.php_ext%'            # 11. Extension PHP (.php)
            - '@config'                   # 12. Configuration
            - '@notification_manager'     # 13. Gestionnaire de notifications

    # =========================================================================
    # CONTRÔLEUR DE TEST
    # =========================================================================
    # Contrôleur pour les tests et le débogage
    
    bastien59960.reactions.test:
        class: bastien59960\reactions\controller\test
        arguments:
            - '@dbal.conn'                # 1. Base de données
            - '@user'                     # 2. Utilisateur courant
            - '%tables.post_reactions%'   # 3. Table des réactions
            - '%tables.posts%'            # 4. Table des messages

    # =========================================================================
    # TÂCHE CRON - ENVOI GROUPÉ DES NOTIFICATIONS
    # =========================================================================
    # Exécutée périodiquement pour envoyer les emails de notifications
    # de manière groupée (anti-spam)
    
    bastien59960.reactions.notificationtask:
        class: bastien59960\reactions\cron\notification_task
        arguments:
            - '@dbal.conn'                    # 1. Base de données
            - '@config'                       # 2. Configuration
            - '@notification_manager'         # 3. Gestionnaire de notifications
            - '@user_loader'                  # 4. Chargeur d'utilisateurs
            - '%tables.post_reactions%'       # 5. Table des réactions
            - '%core.root_path%'              # 6. Chemin racine
            - '%core.php_ext%'                # 7. Extension PHP
            - '%tables.reactions_user_prefs%' # 8. Table des préférences utilisateur
        tags:
            - { name: cron.task }             # Enregistre comme tâche cron

    # =========================================================================
    # TYPE DE NOTIFICATION - RÉACTIONS (NOTIFICATIONS INSTANTANÉES)
    # =========================================================================
    # Définit le type de notification "notification.type.reaction"
    # Utilisé pour les notifications dans la "cloche" phpBB
    # 
    # ⚠️ ORDRE DES ARGUMENTS CRITIQUE ⚠️
    # Les 7 premiers arguments DOIVENT correspondre à la classe parente
    # phpbb\notification\type\base dans cet ordre exact :
    # 1. db, 2. language, 3. user, 4. auth, 5. root_path, 6. php_ext, 7. table
    # 
    # Les suivants sont spécifiques à notre extension
    
    bastien59960.reactions.notification:
        class: bastien59960\reactions\notification\type\reaction
        arguments:
            # --- Arguments requis par la classe parente base ---
            - '@dbal.conn'                           # 1. db (driver_interface)
            - '@language'                            # 2. language
            - '@user'                                # 3. user
            - '@auth'                                # 4. auth
            # --- Arguments supplémentaires de notre extension ---
            - '@config'                              # 5. config
            - '@user_loader'                         # 6. user_loader
            - '@controller.helper'                   # 7. helper
            - '@request'                             # 8. request
            - '@template'                            # 9. template
            # --- Arguments requis par la classe parente (suite) ---
            - '%core.root_path%'                     # 10. phpbb_root_path
            - '%core.php_ext%'                       # 11. php_ext
            - '%core.table_prefix%notifications'     # 12. notifications_table (CORRIGÉ: ajout du préfixe)
        tags:
            - { name: notification.type }            # Enregistre comme type de notification
          
    # =========================================================================
    # CONTRÔLEUR UCP - PRÉFÉRENCES UTILISATEUR
    # =========================================================================
    # Gère la page de configuration dans le Centre de Contrôle Utilisateur
    # Permet à chaque utilisateur de choisir :
    # - S'il veut recevoir les notifications dans la cloche
    # - S'il veut recevoir les emails groupés (cron)
    
    bastien59960.reactions.controller.ucp_reactions:
        class: bastien59960\reactions\controller\ucp_reactions
        arguments:
            - '@user'                     # 1. Utilisateur courant
            - '@dbal.conn'                # 2. Base de données
            - '@request'                  # 3. Requêtes HTTP
            - '@template'                 # 4. Templates
            - '%core.table_prefix%'       # 5. Préfixe des tables

    # =========================================================================
    # TYPE DE NOTIFICATION - EMAIL GROUPÉ (CRON)
    # =========================================================================
    # Type de notification spécial pour les emails envoyés par le cron
    # Permet d'envoyer un résumé périodique des réactions reçues
    
    bastien59960.reactions.notification.cron_email:
        class: bastien59960\reactions\notification\type\reaction_email_digest
        arguments:
            - '@user'                     # 1. Utilisateur
            - '@dbal.conn'                # 2. Base de données
            - '@config'                   # 3. Configuration
            - '@template'                 # 4. Templates
            - '@language'                 # 5. Langues
            - '@log'                      # 6. Log système
            - '%core.root_path%'          # 7. Chemin racine
            - '%core.php_ext%'            # 8. Extension PHP
        tags:
            - { name: notification.type } # Enregistre comme type de notification
