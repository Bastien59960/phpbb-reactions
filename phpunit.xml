<?xml version="1.0" encoding="UTF-8"?>
<!--
    Configuration PHPUnit pour l'extension Reactions
    
    Ce fichier configure les tests unitaires et d'intégration
    pour l'extension Reactions. Il définit les répertoires de tests,
    les règles de couverture de code, et les options de test.
    
    Utilisation :
    - Tests unitaires : phpunit tests/unit/
    - Tests d'intégration : phpunit tests/integration/
    - Tous les tests : phpunit
    - Avec couverture : phpunit --coverage-html coverage/
-->

<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/9.5/phpunit.xsd"
         bootstrap="tests/bootstrap.php"
         colors="true"
         processIsolation="false"
         stopOnFailure="false"
         cacheResult="true"
         cacheResultFile=".phpunit.result.cache">

    <!-- ============================================================================= -->
    <!-- CONFIGURATION GÉNÉRALE -->
    <!-- ============================================================================= -->
    
    <testsuites>
        <!-- Tests unitaires -->
        <testsuite name="Unit">
            <directory>tests/unit</directory>
        </testsuite>
        
        <!-- Tests d'intégration -->
        <testsuite name="Integration">
            <directory>tests/integration</directory>
        </testsuite>
        
        <!-- Tests de fonctionnalité -->
        <testsuite name="Functional">
            <directory>tests/functional</directory>
        </testsuite>
    </testsuites>

    <!-- ============================================================================= -->
    <!-- COUVERTURE DE CODE -->
    <!-- ============================================================================= -->
    
    <coverage processUncoveredFiles="true">
        <include>
            <directory suffix=".php">./</directory>
        </include>
        <exclude>
            <directory>tests</directory>
            <directory>vendor</directory>
            <directory>node_modules</directory>
            <file>composer.json</file>
            <file>phpunit.xml</file>
            <file>README.md</file>
            <file>CHANGELOG.md</file>
            <file>DOCUMENTATION.md</file>
            <file>GUIDE_DEVELOPPEMENT.md</file>
            <file>GUIDE_INSTALLATION.md</file>
        </exclude>
        <report>
            <html outputDirectory="coverage/html"/>
            <text outputFile="coverage/text.txt"/>
            <clover outputFile="coverage/clover.xml"/>
        </report>
    </coverage>

    <!-- ============================================================================= -->
    <!-- CONFIGURATION PHP -->
    <!-- ============================================================================= -->
    
    <php>
        <!-- Variables d'environnement pour les tests -->
        <env name="APP_ENV" value="test"/>
        <env name="APP_DEBUG" value="true"/>
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>
        
        <!-- Configuration des tests -->
        <ini name="memory_limit" value="512M"/>
        <ini name="max_execution_time" value="300"/>
        <ini name="error_reporting" value="E_ALL"/>
        <ini name="display_errors" value="1"/>
        <ini name="log_errors" value="1"/>
        <ini name="error_log" value="tests/logs/php_errors.log"/>
    </php>

    <!-- ============================================================================= -->
    <!-- FILTRES ET RÈGLES -->
    <!-- ============================================================================= -->
    
    <filter>
        <whitelist>
            <directory suffix=".php">./</directory>
            <exclude>
                <directory>tests</directory>
                <directory>vendor</directory>
                <directory>node_modules</directory>
                <file>composer.json</file>
                <file>phpunit.xml</file>
                <file>README.md</file>
                <file>CHANGELOG.md</file>
                <file>DOCUMENTATION.md</file>
                <file>GUIDE_DEVELOPPEMENT.md</file>
                <file>GUIDE_INSTALLATION.md</file>
            </exclude>
        </whitelist>
    </filter>

    <!-- ============================================================================= -->
    <!-- CONFIGURATION DES TESTS -->
    <!-- ============================================================================= -->
    
    <logging>
        <junit outputFile="tests/logs/junit.xml"/>
        <testdoxHtml outputFile="tests/logs/testdox.html"/>
        <testdoxText outputFile="tests/logs/testdox.txt"/>
    </logging>

    <!-- ============================================================================= -->
    <!-- EXTENSIONS ET PLUGINS -->
    <!-- ============================================================================= -->
    
    <extensions>
        <extension class="PHPUnit\Extension\CodeCoverage\Driver\Xdebug3Driver"/>
    </extensions>

    <!-- ============================================================================= -->
    <!-- CONFIGURATION SPÉCIFIQUE -->
    <!-- ============================================================================= -->
    
    <!-- Configuration pour les tests de base de données -->
    <php>
        <ini name="pdo_mysql.default_socket" value="/tmp/mysql.sock"/>
        <ini name="mysqli.default_socket" value="/tmp/mysql.sock"/>
    </php>

    <!-- Configuration pour les tests de performance -->
    <php>
        <ini name="opcache.enable" value="0"/>
        <ini name="opcache.enable_cli" value="0"/>
    </php>

    <!-- Configuration pour les tests de sécurité -->
    <php>
        <ini name="allow_url_fopen" value="0"/>
        <ini name="allow_url_include" value="0"/>
    </php>

</phpunit>
